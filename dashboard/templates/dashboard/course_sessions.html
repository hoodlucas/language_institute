{% extends "dashboard/layout.html" %}

{% block title %}Sessions for {{ course.name }}{% endblock %}

{% block content %}
    <h1>Sessions for {{ course.name }}</h1>
    <p>{{ course.description }}</p>

    <p>
        <a href="{% url 'create_class_session' %}?course={{ course.id }}">‚ûï Add New Session</a>
    </p>

    {% if sessions %}
        <ul>
        {% for session in sessions %}
            <li>
                <strong>{{ session.date }}</strong><br>
                Topic: {{ session.topic|default:"(no topic)" }}<br>
                Note: {{ session.note|default:"(no notes)" }}<br>

                <a href="{% url 'edit_class_session' session.id %}">‚úè Edit</a> |
                <button onclick="confirmDelete('{{ session.id }}')">üóë Delete</button>

                <form id="delete-form-{{ session.id }}" method="post" action="{% url 'delete_class_session' session.id %}" style="display:none;">
                    {% csrf_token %}
                </form>

                {% if session.materials.all %}
                    <h4>Materials:</h4>
                    <ul>
                    {% for material in session.materials.all %}
                        <li>
                            üìé <a href="{{ material.file.url }}" target="_blank">{{ material.file.name|slice:"9:" }}</a>
                            <button onclick="confirmDeleteMaterial('{{ material.id }}')">Delete</button>

                            <form id="delete-material-form-{{ material.id }}" method="post" action="{% url 'delete_material' material.id %}" style="display:none;">
                                {% csrf_token %}
                            </form>
                        </li>
                    {% endfor %}
                    </ul>
                {% endif %}

                {% if session.id %}
                    <a href="{% url 'upload_material' session.id %}">üì§ Upload Material</a>
                {% else %}
                    <em>(Cannot upload materials: session not saved)</em>
                {% endif %}
                <hr>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No sessions registered yet.</p>
    {% endif %}

    <p><a href="{% url 'teacher_dashboard' %}">‚Üê Back to Dashboard</a></p>

    <!-- Modal de confirmaci√≥n de material -->
    <div id="confirm-modal-material" style="display:none; position:fixed; top:40%; left:50%; transform:translate(-50%,-50%);
        background:white; border:1px solid #ccc; padding:20px; z-index:1000;">
        <p>Are you sure you want to delete this file?</p>
        <button onclick="submitMaterialDelete()">Yes, delete</button>
        <button onclick="closeMaterialModal()">Cancel</button>
    </div>

    <div id="overlay-material" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.5); z-index:999;" onclick="closeMaterialModal()"></div>


<script>
    // üîπ Confirmaci√≥n para eliminar sesiones
    let formToDelete = null;

    function confirmDelete(sessionId) {
        formToDelete = document.getElementById("delete-form-" + sessionId);
        document.getElementById("confirm-modal").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    }

    function submitDelete() {
        if (formToDelete) {
            formToDelete.submit();
        }
    }

    function closeModal() {
        document.getElementById("confirm-modal").style.display = "none";
        document.getElementById("overlay").style.display = "none";
        formToDelete = null;
    }

    // üîπ Confirmaci√≥n para eliminar materiales
    let materialFormToDelete = null;

    function confirmDeleteMaterial(materialId) {
        materialFormToDelete = document.getElementById("delete-material-form-" + materialId);
        document.getElementById("confirm-modal-material").style.display = "block";
        document.getElementById("overlay-material").style.display = "block";
    }

    function submitMaterialDelete() {
        if (materialFormToDelete) {
            materialFormToDelete.submit();
        }
    }

    function closeMaterialModal() {
        document.getElementById("confirm-modal-material").style.display = "none";
        document.getElementById("overlay-material").style.display = "none";
        materialFormToDelete = null;
    }
</script>
{% endblock %}